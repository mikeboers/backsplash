<!doctype html>
<head>
    <style>

        #container {
            width: 600px;
            min-height: 100%;
            margin: 0 auto;
            position: relative;
            background-color: #888;
        }

        .tile {
            margin: 0 5px 5px 0;
            border: 1px solid #000;
            padding: 10px;
            border-radius: 5px;
            float: left;
            box-sizing: border-box;
            position: absolute;
        }

        .tile-locked {
            border: 4px solid #aa0;
            padding: 7px;
        }


    </style>

    <script src="https://code.jquery.com/jquery-2.1.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/underscore.js/1.7.0/underscore-min.js"></script>
    <script src="mosaic.js"></script>
    <script>jQuery(function ($) {


var flat = function(x) {
    JSON.parse(JSON.stringify(x));
}




var dragee
var mousedown_e
var tiles_without_dragee;
var N;


var resetTiles = function() {

    var tiles = M.tiles;
    N = new Mosaic(M.width);

    for (var i = 0; i < tiles.length; i++) {
        var old_tile = tiles[i];
        if (old_tile.locked) {
            N.place(old_tile)
            old_tile.$node.css({
                left: old_tile.col * (tile_size + padding),
                top: old_tile.row * (tile_size + padding)
            })
        }
    }

    for (var i = 0; i < tiles.length; i++) {
        var old_tile = tiles[i];
        if (!old_tile.locked) {
            var new_tile = N.append(old_tile.width, old_tile.height);
            old_tile.$node.css({
                left: new_tile.col * (tile_size + padding),
                top: new_tile.row * (tile_size + padding)
            })
        }
    }

}



$(document).on('mousedown', '.tile', function(e) {

    mousedown_e = e;
    e.preventDefault();
    var tile = $(this).data('mosaic_tile');

    tile.locked = true;
    tile.$node.addClass('tile-locked');

    console.log('mousedown', tile, e);
    $(window).on('mouseup', mouseUp);
    $(window).on('mousemove', mouseMove);

    dragee = $(this);

    // resetTiles();

})


var mouseMove = function(e) {

    var origin = $('#container').offset();
    var x = e.clientX - origin.left;
    var y = e.clientY - origin.top;

    var row = Math.floor(y / (tile_size + padding));
    var col = Math.floor(x / (tile_size + padding));

    var tile = dragee.data('mosaic_tile');
    var changed = (tile.row != row || tile.col != col);
    tile.row = row;
    tile.col = col;


    console.log('mousemove', row, col);
    e.preventDefault();

    if (changed) {
        resetTiles();
    }

}


var mouseUp = function(e) {
    e.preventDefault();
    console.log('mouseup');
    $(window).off('mouseup', mouseUp);
    $(window).off('mousemove', mouseMove);

    resetTiles();
}




function getRandomColor() {
    var letters = '0123456789ABCDEF'.split('');
    var color = '#';
    for (var i = 0; i < 6; i++ ) {
        color += letters[Math.floor(Math.random() * 16)];
    }
    return color;
}


var tile_size = 50;
var padding = 5;

var M = new Mosaic(10);

for (i = 0; i < 100; i++) {
    var width = 1 + Math.floor(Math.random() * 3);
    var height = 1 + Math.floor(Math.random() * 3);

    //console.time('Mosaic.append');
    var obj = M.append(width, height);
    //console.timeEnd('Mosaic.append');

    var $tile = $('<div class="tile" />')
        .data('mosaic_tile', obj)
        .text(i + ": " + width + "x" + height)
        .css({
            width: width * tile_size + (width - 1) * padding,
            height: height * tile_size + (height - 1) * padding,
            left: obj.col * (tile_size + padding),
            top: obj.row * (tile_size + padding),
            backgroundColor: getRandomColor()
        })
        .appendTo('#container')

    obj.$node = $tile;


}


    })</script>

<body>

    <div id="container"></div>